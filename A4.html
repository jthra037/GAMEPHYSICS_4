<!doctype html>
<html>
   <head>
   <script src = "vector2d.js"></script>
   <script src = "geom2d.js"></script>
   <script src = "physics2d.js"></script>
   </head>
   <body>
      <canvas id="game"></canvas>

      <script>
        var game = document.getElementById("game");
		var ctx = game.getContext("2d");
        game.width = 1280;
        game.height = 720;
        game.style.marginLeft = 0;
        game.style.marginTop = 0;
		var bgReady = false;
	    var ballReady = false;
        var bgImage = new Image();
		var ballimage = new Image();
		var rectImage = new Image();
		var ballx,bally;
		///REPLACING vy AND vx WITH velocity VECTOR
        var vinity = 2; // velocity along y axis
		var vinitx = Math.random()-.5; // velocity along x axis
		var velocity = new vec2d(vinitx, vinity);
		
		var T = Number.POSITIVE_INFINITY;
		var t = 0;
		
		var a = 0; // acceleration
        bgImage.src = "images/bg.jpg";
		ballimage.src = "images/ball.png";
		rectImage.src = "images/rectangle.png"
		
		bgImage.onload = function () {
			bgReady = true;
		}
		
		ballimage.onload = function () {
			ballReady = true;
		}
		
		rectImage.onload = function()  {
			rectReady = true;
		}
		
		bally = 32;
		ballx = 32 + (Math.random() * (game.width - 64));
        var rectx = 500;
		var recty = 670;
		var oldx = rectx;
		var oldy = recty;
		 
		function initCollision()
		{
			var p1 = new Point(rectx, recty);
			var p2 = new Point(rectx + rectImage.width, recty);
			var wall = new Line(p1, new vec2d(1, 0));
			findCollision(p1, p2, wall);
		}
		
		
		function findCollision(p1, p2, wall)
		{
			t = 0;
			circle = new Circle(new Point(ballx,bally),16);
			var newT = circleSegmentCollision(circle, wall, p1, p2, velocity.mul(-1)); // KEEP THE TIME POSITIVE
			if ((newT < Number.POSITIVE_INFINITY) && (newT < 0))
				T = newT;
		}
		 
		function wallBounce(wall)
		{
			t = 0;
			var n = wall.dirVec.perp();
			var px = velocity.x * n.x;
			var py = velocity.y * n.y;
			var P = new vec2d(px, py);
			var v2 = velocity.add(P.mul(-2));
			velocity = v2;
		}
		
		var render = setInterval(function() 
		{
			++t;
			bally = bally + velocity.y;
			ballx = ballx + velocity.x;
			//bally = 32 + (Math.random() * (game.height - 64));
			if (bally >= game.height-32 || (ballx <= 32 ) || (ballx >= game.width-32)) {
				ballx = 32 + (Math.random() * (game.width - 64));
				bally = 32;
				///REPLACING vy AND vx WITH velocity VECTOR
				velocity = new vec2d(Math.random()-.5, vinity);
				///THE BALL RESET, FIND A NEW COLLISION TIME
				initCollision();
			}
		
			if (bgReady) {
				ctx.drawImage(bgImage, 0, 0);
			}
			
			if (ballReady) {
				ctx.drawImage(ballimage, ballx, bally);
			}
			
			if (rectReady) {
				ctx.drawImage(rectImage, rectx, recty);
			}
			
			if (t >= Math.abs(T))
			{
				T = Number.POSITIVE_INFINITY;
				wallBounce(new Line(new Point(rectx, recty), new vec2d(1, 0)));
			}
			
		}, vinity);
		   
		window.onload = function() 
		{
			document.onmousemove = function(e) 
			{
				if (e.which == 1) 
				{
					var newx = e.pageX;
					var newy = e.pageY;
			
					if(newx >= 0 && newx <= rectx+rectImage.width) 
					{
						rectx = newx; 
						oldx = rectx;
						///THE PADDLE MOVED, FIND A NEW COLLISION TIME
						initCollision();
					}
				}
			}
		}
      </script>
   </body>


</html>